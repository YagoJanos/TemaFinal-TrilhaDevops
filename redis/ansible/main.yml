---
- name: Provisioning go calculator
  hosts: 127.0.0.1
  become: true
  
  tasks:
    - name: Instalar o repositório EPEL
      yum:
        name: https://dl.fedoraproject.org/pub/epel/epel-release-latest-7.noarch.rpm
        state: present

    - name: Upgrade all packages
      yum:
        name: '*'
        state: latest

    - name:  Install redis 6
      shell: amazon-linux-extras install redis6

    - name: Alterar as configurações do serviço Redis
      template:
        src: /home/ec2-user/files/redis.conf
        dest: /etc/redis/redis.conf
        owner: redis
        group: redis
        mode: '644'

    - name: Enable service redis
      systemd:
        name: redis
        state: started
        enabled: yes

    - name: Ensure logrotate is installed
      yum:
        name: logrotate
        state: present

    - name: Create Redis logrotate configuration
      copy:
        content: |
          /var/log/redis/*.log {
            daily
            rotate 7
            compress
            delaycompress
            missingok
            notifempty
            create 640 redis redis
            postrotate
              /bin/kill -USR1 `cat /var/run/redis/redis.pid 2>/dev/null` 2>/dev/null || true
            endscript
          }
        dest: /etc/logrotate.d/redis
        owner: root
        group: root
        mode: 0644
    
    - name: Install socat
      yum:
        name: socat
        state: present

    - name: Create Service to execute socat health check
      copy:
        src: /home/ec2-user/files/socat-redis-health.service
        dest: /etc/systemd/system/
        mode: 0644

    - name: Daemon-reload
      systemd:
        daemon_reload: yes

    - name: Enable socat-redis-health service
      systemd:
        name: socat-redis-health
        enabled: yes
